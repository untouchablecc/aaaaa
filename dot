function Vnly_getClosestPlayerToCursor()
    local closestPlayer
    local shortestDistance = 9999

    for i, v in pairs(game.Players:GetPlayers()) do
        if v ~= game.Players.LocalPlayer and v.Character and v.Character:FindFirstChild("Humanoid") and v.Character.Humanoid.Health > 0 and v.Character:FindFirstChild("HumanoidRootPart") then
            local pos = CC:WorldToViewportPoint(v.Character.PrimaryPart.Position)
            local magnitude = (Vector2.new(pos.X, pos.Y) - Vector2.new(mouse.X, mouse.Y)).magnitude
            if magnitude < shortestDistance then
                closestPlayer = v
                shortestDistance = magnitude
            end
        end
    end
    return closestPlayer
end

-- Perform KO, Death, and Grab Checks for Dotlock
function Vnly_performDotChecks(Plr)
    if Dotlock.Checks.CheckKoStatus and Plr and Plr.Character then
        local KOd = Plr.Character:WaitForChild("BodyEffects")["K.O"].Value
        local Grabbed = Plr.Character:FindFirstChild("GRABBING_CONSTRAINT") ~= nil
        if Plr.Character.Humanoid.Health < 1 or KOd or Grabbed then
            enabled = false
            return true
        end
    end

    if Dotlock.Checks.DisableOnTargetDeath and Plr and Plr.Character:FindFirstChild("Humanoid") then
        if Plr.Character.Humanoid.Health < 1 then
            enabled = false
            return true
        end
    end

    if Dotlock.Checks.DisableOnPlayerDeath and game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("Humanoid") then
        if game.Players.LocalPlayer.Character.Humanoid.Health < 1 then
            enabled = false
            return true
        end
    end

    return false
end

game:GetService("RunService").Stepped:connect(function()
    if enabled and Plr and Plr.Character and Plr.Character:FindFirstChild("HumanoidRootPart") then
        if Vnly_performDotChecks(Plr) then
            return
        end

        placemarker.CFrame = CFrame.new(Plr.Character.HumanoidRootPart.Position + (Plr.Character.HumanoidRootPart.Velocity * accommodationFactor))
        
        local updateMousePosEvent = game.ReplicatedStorage:FindFirstChild("UpdateMousePosI2")
        if updateMousePosEvent then
            updateMousePosEvent:FireServer(placemarker.Position)
        end
    else
        placemarker.CFrame = CFrame.new(0, 9999, 0)
    end
end)

game.Players.LocalPlayer:GetMouse().KeyDown:Connect(function(k)
    if k == Dotlock.Key and Dotlock.Enabled then
        if enabled == true then
            enabled = false
            if Dotlock.NOTIF == true then
                Plr = Vnly_getClosestPlayerToCursor()
                game.StarterGui:SetCore("SendNotification", {
                    Title = "Vnly Ware",
                    Text = "Unlocked Dot Lock",
                    Icon = "http://www.roblox.com/asset/?id=8850953349",
                    Duration = 1,
                })
            end
        else
            Plr = Vnly_getClosestPlayerToCursor()
            enabled = true
            if Dotlock.NOTIF == true then
                game.StarterGui:SetCore("SendNotification", {
                    Title = "Vnly Ware",
                    Text = "Locked on: " .. tostring(Plr.Name),
                    Icon = "http://www.roblox.com/asset/?id=8850953349",
                    Duration = 1,
                })
            end
        end
    end
end)
